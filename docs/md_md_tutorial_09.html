<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Louvre: Chapter 9: Keyboard Events</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Louvre
   &#160;<span id="projectnumber">v1.2.1-2</span>
   </div>
   <div id="projectbrief">C++ library for Wayland compositors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Chapter 9: Keyboard Events </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Handling keyboard events closely resembles the process for managing pointer events. You begin by assigning keyboard focus to a surface, and from that point on, all keyboard events are directed to that surface. Keyboard event management is facilitated through the <a class="el" href="class_louvre_1_1_l_keyboard.html" title="Class for handling keyboard events.">Louvre::LKeyboard</a> class and is quite simpler compared to handling pointer events.</p>
<p>There are two key virtual methods you can override:</p>
<ul>
<li><a class="el" href="class_louvre_1_1_l_keyboard.html#a501fc2321bf1c7b72f3029e911450e7d" title="Notifies a key state change.">Louvre::LKeyboard::keyEvent</a>: This event is generated each time a key is pressed or released.</li>
<li><a class="el" href="class_louvre_1_1_l_keyboard.html#ae13224e08b5eb450b42dd2f6e5dab79a" title="Notifies a change in the modifiers state.">Louvre::LKeyboard::keyModifiersEvent</a>: This event is generated whenever the keyboard modifiers change.</li>
</ul>
<h1><a class="anchor" id="autotoc_md244"></a>
Keyboard Mapping</h1>
<p>As discussed in <a href="md_md_tutorial_04.html">Chapter 4: Compositor Initialization</a>, you can set the XKB keymap using the <a class="el" href="class_louvre_1_1_l_keyboard.html#ab7c9828d924ece9974b37e762756eec8" title="Set the keyboard map.">Louvre::LKeyboard::setKeymap()</a> method. The key codes generated by the input backend correspond to the raw codes defined in the <a href="https://github.com/torvalds/linux/blob/master/include/uapi/linux/input-event-codes.h"><code>&lt;linux/input-event-codes.h&gt;</code></a> header. These codes may represent different symbols across various keyboards and can change based on the current modifier state. This is where keymaps come into play, allowing for the correct interpretation of these raw key codes.</p>
<p>You can convert a raw key code into an XKB symbol using the <a class="el" href="class_louvre_1_1_l_keyboard.html#a9d1ccaea916aac15799414bdcaf81b47" title="Key symbol.">Louvre::LKeyboard::keySymbol()</a> method and ascertain the state of a modifier with <a class="el" href="class_louvre_1_1_l_keyboard.html#a574ccdd62d9518aa47ab127ac5605456" title="Check the state of a modifier.">Louvre::LKeyboard::isModActive()</a>. The XKB key symbols are defined in the <a href="https://github.com/xkbcommon/libxkbcommon/blob/master/include/xkbcommon/xkbcommon-keysyms.h"><code>&lt;xkbcommon/xkbcommon-keysyms.h&gt;</code></a> header.</p>
<h1><a class="anchor" id="autotoc_md245"></a>
Keyboard Repeat Rate</h1>
<p>In scenarios where you hold down a key, such as when typing in a text editor, clients typically initiate key repeats after a specific delay. You have the ability to control both the delay and the rate of these repeats using the <a class="el" href="class_louvre_1_1_l_keyboard.html#addeb3f9e49ab39436fbdca3185cdf1c8" title="Set the key repeat rate and delay.">Louvre::LKeyboard::setRepeatInfo()</a> method.</p>
<p>Let's create our own <a class="el" href="class_louvre_1_1_l_keyboard.html" title="Class for handling keyboard events.">Louvre::LKeyboard</a> subclass named <code>EKeyboard</code>:</p>
<h3><a class="anchor" id="autotoc_md246"></a>
src/EKeyboard.h</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef EKEYBOARD_H</span></div>
<div class="line"><span class="preprocessor">#define EKEYBOARD_H</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;LKeyboard.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespace_louvre.html">Louvre</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>EKeyboard : <span class="keyword">public</span> LKeyboard</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    EKeyboard(<span class="keyword">const</span> <span class="keywordtype">void</span> *params);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> keyEvent(<a class="code" href="namespace_louvre.html#a7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> keyCode, KeyState keyState) <span class="keyword">override</span>;</div>
<div class="line">    <span class="keywordtype">void</span> keyModifiersEvent(<a class="code" href="namespace_louvre.html#a7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> depressed, <a class="code" href="namespace_louvre.html#a7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> latched, <a class="code" href="namespace_louvre.html#a7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> locked, <a class="code" href="namespace_louvre.html#a7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> group) <span class="keyword">override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">// EKEYBOARD_H</span></div>
<div class="ttc" id="anamespace_louvre_html"><div class="ttname"><a href="namespace_louvre.html">Louvre</a></div><div class="ttdoc">Namespaces.</div></div>
<div class="ttc" id="anamespace_louvre_html_a7e8aeec7b6541935dfc6f608cd5170ce"><div class="ttname"><a href="namespace_louvre.html#a7e8aeec7b6541935dfc6f608cd5170ce">Louvre::UInt32</a></div><div class="ttdeci">uint32_t UInt32</div><div class="ttdoc">32 bits unsigned integer</div><div class="ttdef"><b>Definition:</b> LNamespaces.h:207</div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md247"></a>
src/EKeyboard.cpp</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/input-event-codes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LCompositor.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LSurface.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LClient.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LCursor.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LOutput.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LLauncher.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LSeat.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LDNDManager.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;EKeyboard.h&quot;</span></div>
<div class="line"> </div>
<div class="line">EKeyboard::EKeyboard(<span class="keyword">const</span> <span class="keywordtype">void</span> *params) : LKeyboard(params) {}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> EKeyboard::keyEvent(UInt32 keyCode, KeyState keyState)</div>
<div class="line">{</div>
<div class="line">    sendKeyEvent(keyCode, keyState);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span> L_CTRL      { isKeyCodePressed(KEY_LEFTCTRL) };</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span> L_SHIFT     { isKeyCodePressed(KEY_LEFTSHIFT) };</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span> mods        { isKeyCodePressed(KEY_LEFTALT) &amp;&amp; L_CTRL };</div>
<div class="line">    <span class="keyword">const</span> xkb_keysym_t sym { keySymbol(keyCode) };</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (keyState == Released)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (keyCode == KEY_F1 &amp;&amp; !mods)</div>
<div class="line">            LLauncher::launch(<span class="stringliteral">&quot;weston-terminal&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (L_CTRL &amp;&amp; (sym == XKB_KEY_q || sym == XKB_KEY_Q))</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (focus())</div>
<div class="line">                focus()-&gt;client()-&gt;destroy();</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (L_CTRL &amp;&amp; (sym == XKB_KEY_m || sym == XKB_KEY_M))</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (focus() &amp;&amp; focus()-&gt;toplevel() &amp;&amp; !focus()-&gt;toplevel()-&gt;fullscreen())</div>
<div class="line">                focus()-&gt;setMinimized(<span class="keyword">true</span>);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Screenshot</span></div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (L_CTRL &amp;&amp; L_SHIFT &amp;&amp; keyCode == KEY_3)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (cursor()-&gt;output() &amp;&amp; cursor()-&gt;output()-&gt;bufferTexture(0))</div>
<div class="line">            {</div>
<div class="line">                std::filesystem::path path { getenvString(<span class="stringliteral">&quot;HOME&quot;</span>) };</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> (path.empty())</div>
<div class="line">                    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">                path /= <span class="stringliteral">&quot;Desktop/Louvre_Screenshoot_&quot;</span>;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordtype">char</span> timeString[32];</div>
<div class="line">                <span class="keyword">const</span> <span class="keyword">auto</span> now { std::chrono::system_clock::now() };</div>
<div class="line">                <span class="keyword">const</span> <span class="keyword">auto</span> time { std::chrono::system_clock::to_time_t(now) };</div>
<div class="line">                std::strftime(timeString, <span class="keyword">sizeof</span>(timeString), <span class="stringliteral">&quot;%Y-%m-%d %H:%M:%S.png&quot;</span>, std::localtime(&amp;time));</div>
<div class="line"> </div>
<div class="line">                path += timeString;</div>
<div class="line"> </div>
<div class="line">                cursor()-&gt;output()-&gt;bufferTexture(0)-&gt;save(path);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (keyCode == KEY_ESC &amp;&amp; L_CTRL &amp;&amp; L_SHIFT)</div>
<div class="line">        {</div>
<div class="line">            compositor()-&gt;finish();</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (L_CTRL &amp;&amp; !L_SHIFT)</div>
<div class="line">            seat()-&gt;dndManager()-&gt;setPreferredAction(LDNDManager::Copy);</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!L_CTRL &amp;&amp; L_SHIFT)</div>
<div class="line">            seat()-&gt;dndManager()-&gt;setPreferredAction(LDNDManager::Move);</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!L_CTRL &amp;&amp; !L_SHIFT)</div>
<div class="line">            seat()-&gt;dndManager()-&gt;setPreferredAction(LDNDManager::NoAction);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Key pressed</span></div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// CTRL sets Copy as the preferred action in drag &amp; drop session</span></div>
<div class="line">        <span class="keywordflow">if</span> (L_CTRL)</div>
<div class="line">            seat()-&gt;dndManager()-&gt;setPreferredAction(LDNDManager::Copy);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// SHIFT sets the Move as the preferred action in drag &amp; drop session</span></div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (L_SHIFT)</div>
<div class="line">            seat()-&gt;dndManager()-&gt;setPreferredAction(LDNDManager::Move);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> EKeyboard::keyModifiersEvent(UInt32 depressed, UInt32 latched, UInt32 locked, UInt32 group)</div>
<div class="line">{</div>
<div class="line">    sendModifiersEvent(depressed, latched, locked, group);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Once again we are using the default implementation provided by <a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a>. We will delve into the details of what it does shortly. However, before we do that, let's override the <a class="el" href="class_louvre_1_1_l_compositor.html#a507588410b4f53b9bcf824b2168b49d2" title="Virtual constructor for creating the LKeyboard instance during LSeat initialization.">Louvre::LCompositor::createKeyboardRequest()</a> virtual constructor:</p>
<h3><a class="anchor" id="autotoc_md248"></a>
src/ECompositor.h</h3>
<div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Virtual constructors</span></div>
<div class="line">LOutput *createOutputRequest(<span class="keyword">const</span> <span class="keywordtype">void</span> *params) <span class="keyword">override</span>;</div>
<div class="line">LSurface *createSurfaceRequest(<span class="keyword">const</span> <span class="keywordtype">void</span> *params) <span class="keyword">override</span>;</div>
<div class="line">LPointer *createPointerRequest(<span class="keyword">const</span> <span class="keywordtype">void</span> *params) <span class="keyword">override</span>;</div>
<div class="line">LKeyboard *createKeyboardRequest(<span class="keyword">const</span> <span class="keywordtype">void</span> *params) <span class="keyword">override</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md249"></a>
src/ECompositor.cpp</h3>
<div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;EKeyboard.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">LKeyboard *ECompositor::createKeyboardRequest(<span class="keyword">const</span> <span class="keywordtype">void</span> *params)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">new</span> EKeyboard(params);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Let's take a closer look at what's happening in <a class="el" href="class_louvre_1_1_l_keyboard.html#a501fc2321bf1c7b72f3029e911450e7d" title="Notifies a key state change.">Louvre::LKeyboard::keyEvent()</a>:</p>
<h3><a class="anchor" id="autotoc_md250"></a>
src/EKeyboard.cpp</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> EKeyboard::keyEvent(UInt32 keyCode, KeyState keyState)</div>
<div class="line">{</div>
<div class="line">    sendKeyEvent(keyCode, keyState);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span> L_CTRL      { isKeyCodePressed(KEY_LEFTCTRL) };</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span> L_SHIFT     { isKeyCodePressed(KEY_LEFTSHIFT) };</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span> mods        { isKeyCodePressed(KEY_LEFTALT) &amp;&amp; L_CTRL };</div>
<div class="line">    <span class="keyword">const</span> xkb_keysym_t sym { keySymbol(keyCode) };</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>First, we simply send the key event to the currently focused surface, set with <a class="el" href="class_louvre_1_1_l_keyboard.html#ab600af38a7a8579ddcaf35c4b2efee49" title="Set keyboard focus.">Louvre::LKeyboard::setFocus()</a> as we discussed in the previous chapter.</p>
<blockquote class="doxtable">
<p>It's worth noting that we send the raw key codes to the client and not XKB symbols. Clients use the same keymap we set in <a href="md_md_tutorial_04.html">Chapter 4: Compositor Initialization</a> which is automatically sent to them when they connect to the compositor. </p>
</blockquote>
<p>Next, we use raw key codes to detect whether the left <code>Ctrl</code>, <code>Shift</code>, and <code>Alt</code> keys are pressed. We are not using the <a class="el" href="class_louvre_1_1_l_keyboard.html#a574ccdd62d9518aa47ab127ac5605456" title="Check the state of a modifier.">Louvre::LKeyboard::isModActive()</a> method because it would also return <code>true</code> if, for example, we press the right <code>Shift</code> or <code>Alt</code> keys. The <a class="el" href="class_louvre_1_1_l_keyboard.html#a7da39958ef573675cf3c8054e94cfe8c" title="Check if a key code is pressed.">Louvre::LKeyboard::isKeyCodePressed()</a> method allows us to determine if a raw key code is pressed. Additionally, we can obtain a list of all currently pressed keys using <a class="el" href="class_louvre_1_1_l_keyboard.html#a39da4a135b808a56036a594014b0a8d7" title="Vector of pressed key codes.">Louvre::LKeyboard::pressedKeys()</a>.</p>
<h3><a class="anchor" id="autotoc_md251"></a>
src/EKeyboard.cpp</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> EKeyboard::keyEvent(UInt32 keyCode, KeyState keyState)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (keyState == Released)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (keyCode == KEY_F1 &amp;&amp; !mods)</div>
<div class="line">            LLauncher::launch(<span class="stringliteral">&quot;weston-terminal&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>Then, when the <code>F1</code> key is released, we launch <a href="https://gitlab.freedesktop.org/wayland/weston">weston-terminal</a>.</p>
<p>We also verify that both the left <code>Ctrl</code> and <code>Alt</code> keys are not pressed during this process. This check is necessary because when you press <code>Ctrl + Alt + F[1,...,10]</code>, the system switches to another TTY (if libseat is enabled).</p>
<h3><a class="anchor" id="autotoc_md252"></a>
src/EKeyboard.cpp</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> EKeyboard::keyEvent(UInt32 keyCode, KeyState keyState)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (keyState == Released)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (L_CTRL &amp;&amp; (sym == XKB_KEY_q || sym == XKB_KEY_Q))</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (focus())</div>
<div class="line">                focus()-&gt;client()-&gt;destroy();</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>If we press <code>Ctrl + Q</code>, we invoke <a class="el" href="class_louvre_1_1_l_client.html#a3a80b6032f86a56bec74609034b3246f" title="Terminates the client connection with the compositor.">Louvre::LClient::destroy()</a> to the client owner of the currently keyboard-focused surface. This action essentially disconnects the client from the compositor.<br  />
It's important to note that this approach is somewhat abrupt, as it doesn't provide the client an opportunity, for example, to display a "Save before exit" dialog. A more graceful alternative to consider is using <a class="el" href="class_louvre_1_1_l_toplevel_role.html#a2b477452c90b7877914714280c4510ad" title="Closes the Toplevel.">Louvre::LToplevelRole::close()</a> instead.</p>
<h3><a class="anchor" id="autotoc_md253"></a>
src/EKeyboard.cpp</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> EKeyboard::keyEvent(UInt32 keyCode, KeyState keyState)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (keyState == Released)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (L_CTRL &amp;&amp; (sym == XKB_KEY_m || sym == XKB_KEY_M))</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (focus() &amp;&amp; focus()-&gt;toplevel() &amp;&amp; !focus()-&gt;toplevel()-&gt;fullscreen())</div>
<div class="line">                focus()-&gt;setMinimized(<span class="keyword">true</span>);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>When <code>Ctrl + M</code> is pressed, we minimize the currently focused surface.</p>
<h3><a class="anchor" id="autotoc_md254"></a>
src/EKeyboard.cpp</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> EKeyboard::keyEvent(UInt32 keyCode, KeyState keyState)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (keyState == Released)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Screenshot</span></div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (L_CTRL &amp;&amp; L_SHIFT &amp;&amp; keyCode == KEY_3)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (cursor()-&gt;output() &amp;&amp; cursor()-&gt;output()-&gt;bufferTexture(0))</div>
<div class="line">            {</div>
<div class="line">                std::filesystem::path path { getenvString(<span class="stringliteral">&quot;HOME&quot;</span>) };</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> (path.empty())</div>
<div class="line">                    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">                path /= <span class="stringliteral">&quot;Desktop/Louvre_Screenshoot_&quot;</span>;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordtype">char</span> timeString[32];</div>
<div class="line">                <span class="keyword">const</span> <span class="keyword">auto</span> now { std::chrono::system_clock::now() };</div>
<div class="line">                <span class="keyword">const</span> <span class="keyword">auto</span> time { std::chrono::system_clock::to_time_t(now) };</div>
<div class="line">                std::strftime(timeString, <span class="keyword">sizeof</span>(timeString), <span class="stringliteral">&quot;%Y-%m-%d %H:%M:%S.png&quot;</span>, std::localtime(&amp;time));</div>
<div class="line"> </div>
<div class="line">                path += timeString;</div>
<div class="line"> </div>
<div class="line">                cursor()-&gt;output()-&gt;bufferTexture(0)-&gt;save(path);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>When <code>Ctrl + Shift + 3</code> is pressed, we capture a screenshot of the output where the cursor is currently located and save it to your desktop directory.</p>
<h3><a class="anchor" id="autotoc_md255"></a>
src/EKeyboard.cpp</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> EKeyboard::keyEvent(UInt32 keyCode, KeyState keyState)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (keyState == Released)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (keyCode == KEY_ESC &amp;&amp; L_CTRL &amp;&amp; L_SHIFT)</div>
<div class="line">        {</div>
<div class="line">            compositor()-&gt;finish();</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>If <code>Ctrl + Shift + Esc</code> is pressed, we exit the compositor using <a class="el" href="class_louvre_1_1_l_compositor.html#a6dfe1abe0d1eb3ddc1ca081de98b5342" title="Ends and uninitializes the compositor.">Louvre::LCompositor::finish()</a>.</p>
<h3><a class="anchor" id="autotoc_md256"></a>
src/EKeyboard.cpp</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> EKeyboard::keyEvent(UInt32 keyCode, KeyState keyState)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (keyState == Released)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (L_CTRL &amp;&amp; !L_SHIFT)</div>
<div class="line">            seat()-&gt;dndManager()-&gt;setPreferredAction(LDNDManager::Copy);</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!L_CTRL &amp;&amp; L_SHIFT)</div>
<div class="line">            seat()-&gt;dndManager()-&gt;setPreferredAction(LDNDManager::Move);</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!L_CTRL &amp;&amp; !L_SHIFT)</div>
<div class="line">            seat()-&gt;dndManager()-&gt;setPreferredAction(LDNDManager::NoAction);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Key press</span></div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// CTRL sets Copy as the preferred action in drag &amp; drop session</span></div>
<div class="line">        <span class="keywordflow">if</span> (L_CTRL)</div>
<div class="line">            seat()-&gt;dndManager()-&gt;setPreferredAction(LDNDManager::Copy);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// SHIFT sets the Move as the preferred action in drag &amp; drop session</span></div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (L_SHIFT)</div>
<div class="line">            seat()-&gt;dndManager()-&gt;setPreferredAction(LDNDManager::Move);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Lastly, during a drag &amp; drop operation, we have the option to select our preferred action. Typically, if you are dragging a file to another directory, pressing <code>Ctrl</code> would indicate the action to copy the file, while pressing <code>Shift</code> would indicate the action to move the file. If neither <code>Ctrl</code> nor <code>Shift</code> is pressed, we unset the preferred action and leave it to the clients to decide.</p>
<p>The implementation of <a class="el" href="class_louvre_1_1_l_keyboard.html#ae13224e08b5eb450b42dd2f6e5dab79a" title="Notifies a change in the modifiers state.">Louvre::LKeyboard::keyModifiersEvent()</a> is straightforward and doesn't require much explanation. We are simply sending the updated keyboard modifier states to the client.</p>
<h1><a class="anchor" id="autotoc_md257"></a>
Handling Keyboard Events with LScene</h1>
<p>Similar to pointer events, we can also delegate keyboard event handling to <a class="el" href="class_louvre_1_1_l_scene.html" title="The LScene class is an optional utility that significantly simplifies rendering.">Louvre::LScene</a>, which provides the added benefit of emitting per-view keyboard events. To enable <a class="el" href="class_louvre_1_1_l_scene.html" title="The LScene class is an optional utility that significantly simplifies rendering.">Louvre::LScene</a> for this purpose, simply "plug it" like this:</p>
<h3><a class="anchor" id="autotoc_md258"></a>
src/EKeyboard.cpp</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;LScene.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;EKeyboard.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Global.h&quot;</span></div>
<div class="line"> </div>
<div class="line">EKeyboard::EKeyboard(<span class="keyword">const</span> <span class="keywordtype">void</span> *params) : LKeyboard(params) {}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> EKeyboard::keyEvent(UInt32 keyCode, KeyState keyState)</div>
<div class="line">{</div>
<div class="line">    G::scene()-&gt;handleKeyEvent(keyCode, keyState);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> EKeyboard::keyModifiersEvent(UInt32 depressed, UInt32 latched, UInt32 locked, UInt32 group)</div>
<div class="line">{</div>
<div class="line">    G::scene()-&gt;handleKeyModifiersEvent(depressed, latched, locked, group);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Ahh, clean and beautiful.</p>
<h2><a class="anchor" id="autotoc_md259"></a>
Customizing LScene Event Handling</h2>
<p>Just like with pointer events, you have the option to disable the Wayland events handling while still receiving per-view events by using <a class="el" href="class_louvre_1_1_l_scene.html#acb65b0c36e16e2c85f34a92836ed0019" title="Enable or disable handling of Wayland keyboard events.">Louvre::LScene::enableHandleWaylandKeyboardEvents()</a>. The scene by default also implements the other functionality we saw previously, such as launching <a href="https://gitlab.freedesktop.org/wayland/weston">weston-terminal</a>, exiting the compositor, saving screenshots, etc. You can disable these features using <a class="el" href="class_louvre_1_1_l_scene.html#a1809cfc52b6490db6196a9d898213b79" title="Enable or disable auxiliary keyboard implementation.">Louvre::LScene::enableAuxKeyboardImplementation()</a>.</p>
<blockquote class="doxtable">
<p>Throughout the tutorial, we don't recommend disabling these features because doing so might leave you locked inside your compositor without a shortcut to terminate it or access to a terminal to kill its process. This could potentially force you to restart your machine. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md260"></a>
Native Input Events</h2>
<p><a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a> also offers the ability to monitor native input backend events through the <a class="el" href="class_louvre_1_1_l_seat.html#af9695c9b984698446cdb4b8e25b679b5" title="Native input backend events.">Louvre::LSeat::nativeInputEvent()</a> virtual method. The parameter of this method contains an opaque data structure that can be cast to either a <a href="https://wayland.freedesktop.org/libinput/doc/latest/api/structlibinput__event.html">struct libinput_event</a> or <a href="https://www.x.org/releases/X11R7.6/doc/libX11/specs/libX11/libX11.html">XEvent</a>, depending on whether the libinput or X11 input backend is in use. Use <a class="el" href="class_louvre_1_1_l_seat.html#aed55a49e94c65bcb29de7bd324665458" title="Get the ID of the current input backend.">Louvre::LSeat::inputBackendId()</a> to determine which input backend is in use.</p>
<blockquote class="doxtable">
<p>As of <a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a> v1.0.0, the X11 input backend is considered obsolete and is no longer maintained. Therefore, you can be confident that this method exclusively provides <a href="https://wayland.freedesktop.org/libinput/doc/latest/api/structlibinput__event.html">struct libinput_event</a> events. </p>
</blockquote>
<p>Using this method allows you to tap into a more extensive range of events, including touch events and multi-finger pointer gestures, among others. For a practical demonstration, refer to the <a href="md_md__examples.html#views">louvre-views</a> example which handles three-finger swipe events for workspace switching.</p>
<p>Please note that touch and pointer gesture events are planned for inclusion in the upcoming <a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a> 2.0.0 release, so your patience is appreciated.</p>
<p>In the next chapter, we will explore how to manage toplevel surfaces and prevent them from positioning under the topbar.</p>
<p><a href="md_md_tutorial_08.html">◀ Chapter 8: Pointer Events</a> || <a href="md_md_tutorial_10.html">Chapter 10: Toplevels ▶</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<script>
    var menu = false;
    var burger, nav;
    function resp()
    {
        if (window.innerWidth < 768)
        {
            burger.hidden = false;
            nav.hidden = true;
        }
        else
        {
            burger.hidden = true;
            nav.hidden = false;
        }
        menu = false;
    }
    function toggleMenu()
    {
        nav.hidden = menu;
        menu = !menu;
    }
    window.onload = function()
    {
        // Get all <a> tags with the "el" class
        var elLinks = document.querySelectorAll('a.el');
        // Loop through the matched elements
        elLinks.forEach(function(link) 
        {
            // Replace "Louvre::" with an empty string in the text content
            link.textContent = link.textContent.replace(/Louvre::/g, '');
        });
        nav = document.getElementById('main-nav');
        burger = document.createElement('div');
        burger.style.position = 'absolute';
        burger.style.top = '14px';
        burger.style.right = burger.style.top;
        burger.innerHTML = '<svg onclick="toggleMenu()" height="32px" viewBox="0 0 448 512"><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg>';
        document.getElementById('top').appendChild(burger);
        resp();
    };
    window.onresize = function()
    {
        resp();
    };
</script>
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">Project developed by <a href="https://github.com/CuarzoSoftware"><img class="footer" src="https://avatars.githubusercontent.com/u/29326763?s=200&v=4" style="margin-left:2px;position:relative;top:-1px;width:12px;height:12px" alt="cuarzo"/> Cuarzo Software</a></li>
    </ul>
</div>