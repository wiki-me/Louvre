<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Louvre: Chapter 15: Output Hotplugging and Seat</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Louvre
   &#160;<span id="projectnumber">v1.2.1-2</span>
   </div>
   <div id="projectbrief">C++ library for Wayland compositors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Chapter 15: Output Hotplugging and Seat </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In our earlier discussion within <a href="md_md_tutorial_04.html">Chapter 4: Compositor Initialization</a>, we explored the arrangement of outputs during the compositor initialization process. This chapter delves into the scenarios involving the connection and disconnection of outputs, and as a final addition, we will delve into the handling of TTY switch events.</p>
<p>Whenever a new output is connected, the <a class="el" href="class_louvre_1_1_l_seat.html#ade85a580ee6b9aa3aaead45f948d2e82" title="New available output.">Louvre::LSeat::outputPlugged()</a> event is triggered. Within this method, you have the freedom to decide whether to initialize the output using <a class="el" href="class_louvre_1_1_l_compositor.html#a0b328b0723a35d00bbaff5aec6b9e9e0" title="Initializes the specified output.">Louvre::LCompositor::addOutput()</a> or not. Similarly, when an output is no longer available, the <a class="el" href="class_louvre_1_1_l_seat.html#aff161f8b1d3c715362778773b4b612c6" title="Disconnected output.">Louvre::LSeat::outputUnplugged()</a> event is triggered. If the given output was initialized while unplugged, it is automatically uninitialized after this event, even if you don't explicitly call <a class="el" href="class_louvre_1_1_l_compositor.html#aa6d9794dfb7cb513f834cf503591b864" title="Uninitializes the specified output.">Louvre::LCompositor::removeOutput()</a>.</p>
<p>Let's override these methods to see how to handle these situations:</p>
<h3><a class="anchor" id="autotoc_md335"></a>
src/ESeat.h</h3>
<div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ESeat : <span class="keyword">public</span> LSeat</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> outputPlugged(LOutput *output) <span class="keyword">override</span>;</div>
<div class="line">    <span class="keywordtype">void</span> outputUnplugged(LOutput *output) <span class="keyword">override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md336"></a>
src/ESeat.cpp</h3>
<div class="fragment"><div class="line"><span class="comment">// ..</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;EOutput.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Global.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ESeat::outputPlugged(LOutput *output)</div>
<div class="line">{</div>
<div class="line">    output-&gt;setScale(output-&gt;dpi() &gt;= 200 ? 2 : 1);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (G::outputs().empty())</div>
<div class="line">        output-&gt;setPos(<a class="code" href="namespace_louvre.html#af44d6a74e89490a3e257f317082c93ea">LPoint</a>(0,0));</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        output-&gt;setPos(G::outputs().back()-&gt;pos() + <a class="code" href="namespace_louvre.html#af44d6a74e89490a3e257f317082c93ea">LPoint</a>(G::outputs().back()-&gt;size().w(), 0));</div>
<div class="line"> </div>
<div class="line">    compositor()-&gt;addOutput(output);</div>
<div class="line">    compositor()-&gt;repaintAllOutputs();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ESeat::outputUnplugged(LOutput *output)</div>
<div class="line">{</div>
<div class="line">    compositor()-&gt;removeOutput(output);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespace_louvre.html#a20b0c262d9ef5d263888e463dfa99638">Int32</a> totalWidth { 0 };</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (EOutput *o : G::outputs())</div>
<div class="line">    {</div>
<div class="line">        o-&gt;setPos(<a class="code" href="namespace_louvre.html#af44d6a74e89490a3e257f317082c93ea">LPoint</a>(totalWidth, 0));</div>
<div class="line">        totalWidth += o-&gt;size().w();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    compositor()-&gt;repaintAllOutputs();</div>
<div class="line">}</div>
<div class="ttc" id="anamespace_louvre_html_a20b0c262d9ef5d263888e463dfa99638"><div class="ttname"><a href="namespace_louvre.html#a20b0c262d9ef5d263888e463dfa99638">Louvre::Int32</a></div><div class="ttdeci">int32_t Int32</div><div class="ttdoc">32 bits signed integer</div><div class="ttdef"><b>Definition:</b> LNamespaces.h:210</div></div>
<div class="ttc" id="anamespace_louvre_html_af44d6a74e89490a3e257f317082c93ea"><div class="ttname"><a href="namespace_louvre.html#af44d6a74e89490a3e257f317082c93ea">Louvre::LPoint</a></div><div class="ttdeci">LPointTemplate&lt; Int32, Float32 &gt; LPoint</div><div class="ttdoc">2D vector of 32 bits integers</div><div class="ttdef"><b>Definition:</b> LNamespaces.h:240</div></div>
</div><!-- fragment --><p>When a new output is plugged, our approach is to adjust its scale factor, position it at the rightmost side of the already initialized outputs, and initialize it using <a class="el" href="class_louvre_1_1_l_compositor.html#a0b328b0723a35d00bbaff5aec6b9e9e0" title="Initializes the specified output.">Louvre::LCompositor::addOutput()</a>.</p>
<p>And when an output is unplugged, we first manually uninitialize it just for removing it from <a class="el" href="class_louvre_1_1_l_compositor.html#acbe59b0fc2ef056851b08b27c13ed30a" title="Get a list of all initialized outputs.">Louvre::LCompositor::outputs()</a>. Afterward, we re-arrange the still-initialized outputs.</p>
<p>For a firsthand experience of these changes, recompile and run the compositor, and experiment with plugging and unplugging outputs on the fly to observe how the compositor reacts.</p>
<h2><a class="anchor" id="autotoc_md337"></a>
TTY Switching</h2>
<p>Throughout this tutorial, we've frequently referred to the <a class="el" href="class_louvre_1_1_l_seat.html" title="Group of input and output devices.">Louvre::LSeat</a> class, and you may be curious about its purpose. In the realm of Linux/Wayland, the concept of a "seat" represents a collection of input and output devices. Think of it as a physical "seat" where a user is situated, providing access to their keyboard, mouse, screen, and more. This concept becomes particularly important in scenarios like educational institutions where multiple students can share the same machine, while each having their dedicated monitor, keyboard, and so on. This setup is commonly known as a multi-seat configuration.</p>
<p>However, in the most typical scenario, a single machine is equipped with a single set of input and output devices. In such cases, Linux still allows you to run multiple user sessions concurrently but in different virtual terminals (TTYs), which you can switch between using shortcuts like <code>Ctrl + Shift + [F1, F2, ..., FN]</code> or through the <code>chvt</code> command. This capability enables you to have multiple desktop environments running simultaneously or, in the context of <a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a>, run multiple compositors on different TTYs.</p>
<p>Each of these desktop environments, compositors, etc., needs to interact with input devices and render content on the screen. However, if there is only one physical screen, this simultaneous interaction would be chaotic. Linux device drivers are designed to allow only one process to manage them at a given time. For example, in the DRM/KMS API, the concept of the DRM master exists, and only one process can be the DRM master, thereby controlling the screen content.</p>
<p>Since there are multiple TTYs, there needs to be a way to negotiate these permissions during TTY switches. This is where seat services and libraries like <a href="https://github.com/kennylevinsen/seatd">libseat</a> come into play. Programs that integrate with seat services enable other processes to take ownership of the seat, and <a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a> is no exception.</p>
<p>By default, <a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a> allows users to switch between TTYs using the methods mentioned earlier or by invoking the <a class="el" href="class_louvre_1_1_l_seat.html#a9f0d67ffb2a190bc9c5fe82636c36039" title="Switch session.">Louvre::LSeat::setTTY()</a> method. When the user switches to another TTY, the compositor can no longer listen to input events or draw content on screens. You have the option to disable this feature by setting the <b>LOUVRE_ENABLE_LIBSEAT</b> environment variable to 0. When the compositor is run in this manner, it won't allow any other process to take ownership of the seat, and TTY switching won't be possible.</p>
<p>With this feature enabled, when the user is in another TTY, there is a possibility for other processes to modify resources used by the compositor, such as the hardware cursor plane, CRTCs, among others. <a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a> automatically restores the previous state when resuming the session. However, the <a class="el" href="class_louvre_1_1_l_scene.html" title="The LScene class is an optional utility that significantly simplifies rendering.">Louvre::LScene</a> inter-frame damage calculation may go out of sync. To appropriately manage such cases and keep track of TTY switches, you can override the virtual method <a class="el" href="class_louvre_1_1_l_seat.html#aea6456786bfb490e4e3f22370fd586cd" title="Notify a change in the enabled() property.">Louvre::LSeat::enabledChanged()</a>.</p>
<h3><a class="anchor" id="autotoc_md338"></a>
src/ESeat.h</h3>
<div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ESeat : <span class="keyword">public</span> LSeat</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// TTY switching</span></div>
<div class="line">    <span class="keywordtype">void</span> enabledChanged() <span class="keyword">override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md339"></a>
src/ESeat.cpp</h3>
<div class="fragment"><div class="line"><span class="comment">// ..</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;LSceneView.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LScene.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LCursor.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ESeat::enabledChanged()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!enabled())</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Synchronize LScene&#39;s output inter-frame damage tracking by performing</span></div>
<div class="line"><span class="comment">     * full damage on all outputs. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (EOutput *output : G::outputs())</div>
<div class="line">    {</div>
<div class="line">        G::scene()-&gt;mainView()-&gt;damageAll(output);</div>
<div class="line">        output-&gt;repaint();</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Here, each time the seat is re-enabled, indicating a user's return from another session, we apply damage to all the outputs within our scene. This precautionary measure helps prevent the occurrence of odd visual glitches.</p>
<p><a href="md_md_tutorial_14.html">◀ Chapter 14: Clipboard and DND</a> || <a href="md_md_tutorial_16.html">Chapter 16: Gamma Correction ▶</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<script>
    var menu = false;
    var burger, nav;
    function resp()
    {
        if (window.innerWidth < 768)
        {
            burger.hidden = false;
            nav.hidden = true;
        }
        else
        {
            burger.hidden = true;
            nav.hidden = false;
        }
        menu = false;
    }
    function toggleMenu()
    {
        nav.hidden = menu;
        menu = !menu;
    }
    window.onload = function()
    {
        // Get all <a> tags with the "el" class
        var elLinks = document.querySelectorAll('a.el');
        // Loop through the matched elements
        elLinks.forEach(function(link) 
        {
            // Replace "Louvre::" with an empty string in the text content
            link.textContent = link.textContent.replace(/Louvre::/g, '');
        });
        nav = document.getElementById('main-nav');
        burger = document.createElement('div');
        burger.style.position = 'absolute';
        burger.style.top = '14px';
        burger.style.right = burger.style.top;
        burger.innerHTML = '<svg onclick="toggleMenu()" height="32px" viewBox="0 0 448 512"><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg>';
        document.getElementById('top').appendChild(burger);
        resp();
    };
    window.onresize = function()
    {
        resp();
    };
</script>
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">Project developed by <a href="https://github.com/CuarzoSoftware"><img class="footer" src="https://avatars.githubusercontent.com/u/29326763?s=200&v=4" style="margin-left:2px;position:relative;top:-1px;width:12px;height:12px" alt="cuarzo"/> Cuarzo Software</a></li>
    </ul>
</div>