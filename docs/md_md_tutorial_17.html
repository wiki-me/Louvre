<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Louvre: Chapter 17: Fractional Scaling</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Louvre
   &#160;<span id="projectnumber">v1.2.1-2</span>
   </div>
   <div id="projectbrief">C++ library for Wayland compositors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Chapter 17: Fractional Scaling </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>We briefly touched upon it in <a href="md_md_tutorial_04.html">Chapter 4: Compositor Initialization</a> that, starting from version 1.2.0, <a class="el" href="class_louvre_1_1_l_output.html#a10c093b0223c7591bbbc877fc8e8392e" title="Set the output scale factor.">Louvre::LOutput::setScale()</a> now supports fractional scales. While this doesn't alter how rendering is done, it is handled differently internally by <a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a>. To comprehend its functioning, please read <a class="el" href="class_louvre_1_1_l_output.html#Scaling">this section</a> of the <a class="el" href="class_louvre_1_1_l_output.html" title="A display rendering interface.">Louvre::LOutput</a> documentation before proceeding.</p>
<p>Assuming that you've gone through it, you should now be aware that fractional scaling may result in unsightly aliasing artifacts, particularly noticeable on low DPI displays, especially on rendered fonts. This is why <a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a> enables oversampling by default when using fractional scales, which significantly reduces these artifacts but may impact performance. For instance, here is a rather drastic example with two captures of a font being rendered, one with oversampling (at the top) and the other without (at the bottom).</p>
<center> <img src="https://lh3.googleusercontent.com/pw/ABLVV85j3HjCdqdHsTczA6sLH76wouruXqYlORoRbeOL0qNmPyoOoiinwWctALJgxnBoLZeaRfEVdWpJOKTSBBPZklM_N1vDt-i0HYnL2LedBfABVh4EARY=w2400" alt="" style="width:65%" class="inline"/> </center><p>You may observe that even with the drastic scaling factor, the one using oversampling remains quite readable and appears smoother, whereas the other appears somewhat unintelligible, resembling something only understandable to Russians.</p>
<h1><a class="anchor" id="autotoc_md346"></a>
Performance</h1>
<p>Instead of directly using fractional scales, it is advisable to first check if your outputs support different native modes (<a class="el" href="class_louvre_1_1_l_output.html#a9ac403f8d9086b7b95588c0fd6284962" title="Vector of available modes.">Louvre::LOutput::modes()</a>) with the desired resolution and use integer scale factors whenever possible, as oversampling is always disabled when using integer scales.</p>
<p>If that is not the case, when using fractional scales and oversampling, you can still achieve good performance if you are using <a class="el" href="class_louvre_1_1_l_scene.html" title="The LScene class is an optional utility that significantly simplifies rendering.">Louvre::LScene</a> for rendering or manually specifying the damage generated during the rendering of a frame with <a class="el" href="class_louvre_1_1_l_output.html#a5f589c569c0af078f9b537499b2876f2" title="Specify the damaged region of the framebuffer.">Louvre::LOutput::setBufferDamage()</a> like the <em>louvre-weston-clone</em> example does. However, in certain scenarios, such as displaying a video or a game in fullscreen mode, this approach might impact performance, as the entire screen is rendered twice—first into the larger "oversampling" framebuffer and then scaled down to the actual screen framebuffer. In such cases, you could disable oversampling with <a class="el" href="class_louvre_1_1_l_output.html#a44cc14aa351b8cda936faedcfdae8b29" title="Enable or disable oversampling for fractional scales.">Louvre::LOutput::enableFractionalOversampling()</a>. Let's implement that.</p>
<blockquote class="doxtable">
<p>Note: <a class="el" href="class_louvre_1_1_l_scene.html" title="The LScene class is an optional utility that significantly simplifies rendering.">Louvre::LScene</a> automatically damages the entire screen when a fractional scale is used by an output and oversampling is toggled. This is necessary to maintain synchronization in its inter-frame damage tracking. </p>
</blockquote>
<p>First, let's add some keyboard shortcuts to increase and decrease the scaling factor by 0.25 and toggle oversampling.</p>
<h3><a class="anchor" id="autotoc_md347"></a>
src/EKeyboard.cpp</h3>
<div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;LOutput.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;EKeyboard.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> EKeyboard::keyEvent(UInt32 keyCode, KeyState keyState)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (keyState == Released)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> L_META       { isKeyCodePressed(KEY_LEFTMETA) };</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> L_SHIFT      { isKeyCodePressed(KEY_LEFTSHIFT) };</div>
<div class="line">        LOutput *cursorOutput   { cursor()-&gt;output() };</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (L_META &amp;&amp; L_SHIFT &amp;&amp; cursorOutput)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (keyCode == KEY_UP &amp;&amp; cursorOutput-&gt;fractionalScale() &lt; 3.f)</div>
<div class="line">                cursorOutput-&gt;setScale(cursorOutput-&gt;fractionalScale() + 0.25f);</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (keyCode == KEY_DOWN &amp;&amp; cursorOutput-&gt;fractionalScale() &gt; 0.25f)</div>
<div class="line">                cursorOutput-&gt;setScale(cursorOutput-&gt;fractionalScale() - 0.25f);</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (keyCode == KEY_O)</div>
<div class="line">                cursorOutput-&gt;enableFractionalOversampling(!cursorOutput-&gt;fractionalOversamplingEnabled());</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    G::scene()-&gt;handleKeyEvent(keyCode, keyState);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
</div><!-- fragment --><p>Now, by pressing <code>Super + Shift + [Up/Down Arrow]</code>, the output where the cursor is currently located will increase or decrease its scaling factor, and <code>Super + Shift + O</code> will allow you to toggle oversampling on and off.</p>
<p>Experiment a bit with different scaling factors and toggling oversampling to observe any noticeable differences.</p>
<p>Instead of toggling oversampling manually, let's remove the shortcut for that and add a new method on <code>EOutput</code> that returns the first available fullscreen toplevel on the given output or <code>nullptr</code> otherwise.</p>
<h3><a class="anchor" id="autotoc_md348"></a>
src/EOutput.h</h3>
<div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>EToplevel;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>EOutput : <span class="keyword">public</span> LOutput</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">    EToplevel *findFullscreenToplevel() <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md349"></a>
src/EOutput.cpp</h3>
<div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> EOutput::paintGL()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">    EToplevel *fullscreenToplevel { findFullscreenToplevel() };</div>
<div class="line">    enableFractionalOversampling( fullscreenToplevel == <span class="keyword">nullptr</span> );</div>
<div class="line">    G::scene()-&gt;handlePaintGL(<span class="keyword">this</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">EToplevel *EOutput::findFullscreenToplevel()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keywordflow">for</span> (ESurface *surface : G::surfaces())</div>
<div class="line">        <span class="keywordflow">if</span> (surface-&gt;tl() &amp;&amp; surface-&gt;tl()-&gt;fullscreen() &amp;&amp; surface-&gt;tl()-&gt;output == <span class="keyword">this</span>)</div>
<div class="line">            <span class="keywordflow">return</span> surface-&gt;tl();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
</div><!-- fragment --><p>So, now, each time a toplevel is in fullscreen mode on an output, oversampling will be disabled and then re-enabled when there are no fullscreen toplevels.</p>
<blockquote class="doxtable">
<p>Just to reiterate, when using integer scales, oversampling is always disabled, even if you call <code>enableFractionalOversampling(true)</code>. </p>
</blockquote>
<p>In the next chapter, we will explore how to toggle VSync so that our gaming users' eyes can experience a bit of bleeding if they desire it.</p>
<p><a href="md_md_tutorial_16.html">◀ Chapter 16: Gamma Correction</a> || <a href="md_md_tutorial_18.html">Chapter 18: Tearing Control ▶</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<script>
    var menu = false;
    var burger, nav;
    function resp()
    {
        if (window.innerWidth < 768)
        {
            burger.hidden = false;
            nav.hidden = true;
        }
        else
        {
            burger.hidden = true;
            nav.hidden = false;
        }
        menu = false;
    }
    function toggleMenu()
    {
        nav.hidden = menu;
        menu = !menu;
    }
    window.onload = function()
    {
        // Get all <a> tags with the "el" class
        var elLinks = document.querySelectorAll('a.el');
        // Loop through the matched elements
        elLinks.forEach(function(link) 
        {
            // Replace "Louvre::" with an empty string in the text content
            link.textContent = link.textContent.replace(/Louvre::/g, '');
        });
        nav = document.getElementById('main-nav');
        burger = document.createElement('div');
        burger.style.position = 'absolute';
        burger.style.top = '14px';
        burger.style.right = burger.style.top;
        burger.innerHTML = '<svg onclick="toggleMenu()" height="32px" viewBox="0 0 448 512"><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg>';
        document.getElementById('top').appendChild(burger);
        resp();
    };
    window.onresize = function()
    {
        resp();
    };
</script>
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">Project developed by <a href="https://github.com/CuarzoSoftware"><img class="footer" src="https://avatars.githubusercontent.com/u/29326763?s=200&v=4" style="margin-left:2px;position:relative;top:-1px;width:12px;height:12px" alt="cuarzo"/> Cuarzo Software</a></li>
    </ul>
</div>